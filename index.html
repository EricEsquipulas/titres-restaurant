<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calculateur de Titres Restaurant</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 2em; }
    label { display: block; margin-top: 1em; }
    input, select, button { margin-top: 0.5em; padding: 0.4em; width: 100%; }
    table { margin-top: 2em; width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5em; border: 1px solid #ccc; text-align: center; }
    .results { margin-top: 2em; font-weight: bold; }
    .salarie-block { border: 1px solid #ddd; padding: 1em; margin-bottom: 2em; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Calculateur de Titres Restaurant</h1>
  <form id="trForm">
    <div id="salariés"></div>

    <button type="button" onclick="ajouterSalarie()">+ Ajouter une salariée</button>

    <label>Mois (au format AAAA-MM)
      <input type="month" id="mois" required>
    </label>

    <label>Jours fériés (JJ/MM séparés par virgule, prérempli)
      <input type="text" id="feries" value="01/01,01/05,08/05,14/07,15/08,01/11,11/11,25/12">
    </label>

    <button type="submit">Calculer</button>
  </form>

  <div class="results" id="resultat"></div>

  <script>
    let salarieCount = 0;
    const jours = ["lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi", "dimanche"];

    function ajouterSalarie(data = {}) {
      const container = document.getElementById("salariés");
      const block = document.createElement("div");
      block.className = "salarie-block";
      block.innerHTML = `
        <label>Nom
          <input type="text" name="nom" value="${data.nom || ''}" required>
        </label>

        <label>Jours travaillés (Ctrl/Cmd+clic pour sélection multiple)
          <select name="joursTravailles" multiple required>
            ${jours.map(j => `<option ${data.joursTravailles?.includes(j) ? 'selected' : ''}>${j}</option>`).join('')}
          </select>
        </label>

        <label>Jours sans pause déjeuner
          <select name="joursSansPause" multiple>
            ${jours.map(j => `<option ${data.joursSansPause?.includes(j) ? 'selected' : ''}>${j}</option>`).join('')}
          </select>
        </label>
      `;
      container.appendChild(block);
    }

    function getWeekdayName(date) {
      return ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"][date.getDay()];
    }

    function parseFeries(ferieString, year, month) {
      if (!ferieString) return [];
      return ferieString.split(',').map(item => {
        const [day, mon] = item.trim().split('/').map(Number);
        return new Date(year, mon - 1, day).toDateString();
      });
    }

    document.getElementById("trForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const mois = document.getElementById("mois").value;
      const feriesStr = document.getElementById("feries").value;
      const [annee, moisNum] = mois.split("-").map(Number);
      const dernierJour = new Date(annee, moisNum, 0).getDate();
      const feries = parseFeries(feriesStr, annee, moisNum);

      const blocks = document.querySelectorAll(".salarie-block");
      let resultHTML = "";

      blocks.forEach(block => {
        const nom = block.querySelector("input[name='nom']").value;
        const joursTravailles = Array.from(block.querySelector("select[name='joursTravailles']").selectedOptions).map(o => o.value);
        const joursSansPause = Array.from(block.querySelector("select[name='joursSansPause']").selectedOptions).map(o => o.value);

        let total = 0;
        for (let jour = 1; jour <= dernierJour; jour++) {
          const date = new Date(annee, moisNum - 1, jour);
          const nomJour = getWeekdayName(date);
          const dateStr = date.toDateString();
          if (
            joursTravailles.includes(nomJour) &&
            !joursSansPause.includes(nomJour) &&
            !feries.includes(dateStr)
          ) {
            total++;
          }
        }
        resultHTML += `Salariée <strong>${nom}</strong> : <strong>${total}</strong> titres restaurant<br>`;
      });

      document.getElementById("resultat").innerHTML = resultHTML;
    });

    // Chargement initial avec un bloc vide
    ajouterSalarie();
  </script>
</body>
</html>
